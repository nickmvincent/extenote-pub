---
import Layout from '../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';
import matter from 'gray-matter';

// Load content from markdown file
const contentPath = path.resolve('../../content/cb4i/paper.md');
const fileContent = fs.readFileSync(contentPath, 'utf-8');
const { data } = matter(fileContent);

const {
  title, subtitle, conference, paper_links, authors, affiliations,
  hero, problem, solution, stakes, actions, technical, emerging, takeaway,
  references
} = data;

// Helper to get affiliation name by id
const getAffiliation = (id: number) => affiliations.find((a: any) => a.id === id)?.name || '';
---

<Layout>
  <main class="wrap">
    <header>
      <h1>{title}</h1>
      <p class="subtitle">{subtitle}</p>
      <p>
        Read the full paper on
        {paper_links.map((link: any, i: number) => (
          <>
            <a href={link.url}>{link.label}</a>
            {i < paper_links.length - 1 && ' or PDF via '}
          </>
        ))}.
      </p>
      <p class="authors">
        {authors.map((author: any) => (
          <>
            <strong>{author.name}</strong><sup>{author.affiliation}</sup>&nbsp;
          </>
        ))}
      </p>
      <p class="affiliations">
        {affiliations.map((aff: any) => (
          <>
            <sup>{aff.id}</sup>{aff.name}&nbsp;
          </>
        ))}
      </p>
      <p class="conference">{conference}</p>
    </header>

    <section class="hero">
      <h2>{hero.title}</h2>
      <p set:html={hero.definition.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')} />

      <div class="diagram">
        <div class="diagram-node">
          <strong>{hero.diagram.left.title}</strong><br>
          <small>{hero.diagram.left.subtitle}</small>
        </div>
        <div class="diagram-arrow">&harr;</div>
        <div class="diagram-node circle">
          <div>{hero.diagram.center.split(' ').map((word: string, i: number) => <>{word}{i === 0 && <br/>}</>)}</div>
        </div>
        <div class="diagram-arrow">&harr;</div>
        <div class="diagram-node">
          <strong>{hero.diagram.right.title}</strong><br>
          <small>{hero.diagram.right.subtitle}</small>
        </div>
      </div>

      <ul>
        {hero.points.map((point: string) => (
          <li set:html={point.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')} />
        ))}
      </ul>
    </section>

    <div class="two-col">
      <div class="card">
        <h2>{problem.title}</h2>
        {problem.subsections.map((sub: any) => (
          <>
            <h3>{sub.title}</h3>
            <ul>
              {sub.points.map((point: string) => (
                <li set:html={point.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')} />
              ))}
            </ul>
          </>
        ))}
      </div>

      <div class="card">
        <h2>{solution.title}</h2>
        {solution.subsections.map((sub: any) => (
          <>
            <h3>{sub.title}</h3>
            <ul>
              {sub.points.map((point: string) => (
                <li set:html={point.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')} />
              ))}
            </ul>
          </>
        ))}
      </div>
    </div>

    <section class="card">
      <h2>{stakes.title}</h2>
      <div class="two-col" style="margin-bottom: 0;">
        {stakes.columns.map((col: any) => (
          <div>
            <h3>{col.title}</h3>
            <ul>
              {col.points.map((point: string) => <li>{point}</li>)}
            </ul>
          </div>
        ))}
      </div>
    </section>

    <section class="actions">
      <h2>{actions.title}</h2>
      <div class="action-grid">
        {actions.items.map((item: any) => (
          <div class="action-item">
            <h3>{item.title}</h3>
            <p>{item.description}</p>
          </div>
        ))}
      </div>
    </section>

    <section class="card">
      <h2>{technical.title}</h2>
      <p style="margin-bottom: 1.25rem; text-align: center;">{technical.intro}</p>
      <div class="two-col" style="margin-bottom: 0;">
        {technical.columns.map((col: any) => (
          <div>
            <h3>{col.title}</h3>
            <ul>
              {col.points.map((point: string) => <li>{point}</li>)}
            </ul>
          </div>
        ))}
      </div>
      <div class="callout">
        <strong>{technical.callout}</strong>
      </div>
    </section>

    <section class="card">
      <h2>{emerging.title}</h2>
      <ul style="font-size: 1.05rem;">
        {emerging.points.map((point: string) => <li>{point}</li>)}
      </ul>
      <div class="callout" style="font-size: 1.1rem; margin-top: 1.5rem; padding: 1.25rem;">
        <strong>{emerging.callout.main}</strong><br>
        <span style="font-size: 0.95rem;" class="muted">{emerging.callout.sub}</span>
      </div>
    </section>

    <section class="takeaway">
      <h2>{takeaway.title}</h2>
      {takeaway.points.map((point: string) => (
        <p set:html={point.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')} />
      ))}
      <p style="margin-top: 1.5rem; font-size: 1.05rem;" set:html={takeaway.cta.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')} />
      <p class="contact" style="margin-top: 0.75rem;">
        {authors.map((author: any, i: number) => (
          <>{author.email}{i < authors.length - 1 && ' \u2022 '}</>
        ))}
      </p>
    </section>

    {references && references.length > 0 && (
      <section class="card references">
        <h2>Related Work</h2>
        <p class="muted">These papers provide technical and conceptual foundations for CBI. Browse all references at <a href="https://sharedreferences.pages.dev" target="_blank">Shared References</a>.</p>
        <ul class="ref-list">
          {references.map((ref: any) => (
            <li>
              <a href={`https://sharedreferences.pages.dev/reference/${ref.key}`} target="_blank">{ref.label}</a>
              <code>{ref.key}</code>
            </li>
          ))}
        </ul>
      </section>
    )}
  </main>
</Layout>
